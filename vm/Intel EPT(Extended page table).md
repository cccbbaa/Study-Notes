## Intel 扩展页表(翻译自intel 手册)

intel EPT 用于支持物理内存的虚拟化。当EPT使用时，某些通常会被视为物理地址（并用于访问内存）的地址，会被视为**客户物理地址**。客户物理地址通过遍历一组**EPT分页结构**来转换，产生用于访问内存的物理地址。

> 来自GPT
>
> - 在 Intel VT-x 虚拟化中，VM 执行控制被分为主要（Primary）和次要（Secondary）两类。主要控制涵盖了基本的虚拟化功能，而次要控制提供了额外的、更高级的功能，其中就包括 EPT。
>
> - 这里提到的是一组特定的 VM 执行控制位，它们配置在 VMCS（Virtual Machine Control Structure）中，用于控制虚拟机的行为。
> - 第 31 位是一个关键位，用于决定是否启用次要 VM 执行控制。如果这一位被设置为 0，那么所有的次要 VM 执行控制都不会生效。
> - 这意味着，即使在次要 VM 执行控制中启用了 EPT，如果主要控制的第 31 位没有被设置（即为 0），那么 EPT 也不会被启用，处理器将不会使用 EPT 功能。
>
> 

### EPT 预览 

EPT 通过VMX non-root操作转化客户物理地址这也被用于VM入口的事件注入。

客户物理地址转换到物理地址通过**EPT分页结构(EPT paging structures)**实现。EPT分页结构类似于处理器在IA-32e模式下用于线性地址（虚拟地址）转换的分页结构

当CR0的PG（分页）位为1时，线性地址会通过CR3引用的分页结构进行转换。如果启用了HLAT分页，则处理器使用VMCS中的HLAPT字段而非CR3.

> #### 普通分页和HLAT分页
>
> 普通分页(ordinary paging)是标准的4级或5级分页机制，它使用CR3寄存器定位第一个分页结构。
>
> ##### HLAT 分页（Hypervisor-Managed Linear Address Translation Paging）
>
> - **定义**：HLAT 分页是 VMX 非根操作中的一种替代分页形式，仅在“启用 HLAT”VM 执行控制设置为 1 时使用。
> - **工作方式**：与普通分页使用 CR3 寄存器不同，HLAT 分页通过 VMCS 中的一个 VM 执行控制字段 —— HLAT 指针（HLATP）来定位第一个分页结构。
> - **地址转换**：是否使用 HLAT 分页来转换特定的线性地址取决于地址本身及 VMCS 中的 HLAT 前缀大小 VM 执行控制字段。
>   - 如果 HLAT 前缀大小为零，所有线性地址均通过 HLAT 分页进行转换。
>   - 如果 HLAT 前缀大小不为零，则当地址的第 63 位为 1 时使用 HLAT 分页进行转换；如果第 63 位为 0，则使用普通分页。
> - **转换重启**：在某些情况下，HLAT 分页可能指定线性地址的转换需要重新开始。此时，该线性地址将使用普通分页进行转换（从 CR3 标识的分页结构开始）。

"启用EPT" VM执行控制位为1时，客户物理地址依靠CR0的PG位(CR0.PG)确定

- 当 CR0.PG=0，每个线性地址直接被视为客户物理地址。
- 当 CR0.PG=1，客户物理地址是通过CR3寄存器和客户分页结构派生出来的（这包括PDPTEs(页目录指针表项)的值）。对于设置了PS（页大小）位的分页结构条目，它们直接包含了线性地址通过客户分页结构转换后的地址。

当CR0.PG=1时，线性地址到物理地址的转换需要客户物理地址使用EPT进行多次转换。假定一个示例，CR4.PAE = CR4.PSE = 0。(也就是标准的4级分页)，32位线性地址转换会遵循以下规则。

- 线性地址的高10位（位31 : 22）用于从位于CR3指向的客户物理地址的客户也目录中选择一个条目。所选的客户PDE的客户物理地址通过EPT转换以确定其实际物理地址。
- 线性地址的中间10位（位21 : 12）用于从客户PDE指向的客户物理地址的客户页表中选择一个条目。所选的客户PTE的客户物理地址

- 线性地址的低12位（位11 : 0）是在由客户PTE指向的页面框架中的偏移。通过这个偏移确定的客户物理地址通过EPT转换以确定最终的物理地址。

EPT不仅负责地址转换，还指定了软件在访问这些地址时的权限。如果尝试执行不允许的访问，会触发**EPT违规(EPT violations)**导致虚拟机退出。

处理器只有在访问内存时使用EPT转换客户物理地址。这个原则意味着：

- 当执行MOV到CR3的指令时，CR3被加载为一个客户物理地址。这个地址是否通过EPT转换取决于是否使用PAE分页
  - 如果未使用PAE分页(CR0.PG=1, CR4.PAE=0 或 IA32_EFER.LMA=0)，则MOV到CR3的指令不会导致地址通过EPT转换。(如果 CR0.PG=1，下一次使用线性地址访问内存会使用EPT转换)
  - 如果使用PAE分页，MOV到CR3的指令会从该地址加载四个PDPTEs(页目录指针表条目)，这**会**导致地址通过EPT转换
- PDPTEs中包含了客户物理地址。加载PDPTEs的指令(比如上面提到的)不会用到这些地址来访问内存，因此**不会**通过EPT转换。在PDPTE中的地址会在下一次使用线性地址访问内存是通过EPT转换

### EPT转换机制

EPT翻译机制仅使用每个客户端物理地址的低48位(位47 : 0)。因为Intel x64架构的处理器不支持超过48位的物理地址。使用超过48位的客户物理地址会导致页面错误，尝试这样的地址加载到CR3会引发通用保护错误。EPT使用的页走长度为4，也就是说最多访问4个EPT分页结构条目来翻译客户物理地址。(未来处理器可能会支持EPT使用其他的页走长度)。

这48个位被逻辑处理器进行分区，以遍历EPT分页结构：

- 一个4KB自然对齐的EPT PML4（页映射级4）表位于EPTP（扩展页表指针）指定的物理地址处。EPTP是一个VM执行控制字段。
- EPT PML 4表包括512个64位条目(EPT PML4Es)。使用客户物理地址的位47 : 39选取EPT PML4E

